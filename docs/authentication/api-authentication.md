# API Authentication Documentation\n\n## Overview\n\nThis document describes the authentication mechanisms available for the multi-tenant SaaS API. The system supports JWT (JSON Web Token) authentication as the primary method, with backwards compatibility for session-based authentication.\n\n## Authentication Methods\n\n### 1. JWT Authentication (Primary)\n\nJWT authentication is the recommended method for API access. It provides stateless, secure authentication with multi-tenant support.\n\n#### Token Types\n\n- **Access Token**: Short-lived (15 minutes) token for API requests\n- **Refresh Token**: Long-lived (7 days) token for obtaining new access tokens\n\n#### Token Format\n\n```\nAuthorization: Bearer <access_token>\n```\n\n### 2. Session Authentication (Legacy)\n\nSession-based authentication using Django sessions. Maintained for backwards compatibility.\n\n## API Endpoints\n\n### Authentication Endpoints\n\n#### Login\n\n**POST** `/api/auth/login/`\n\nAuthenticate user and receive JWT tokens.\n\n**Request Body:**\n```json\n{\n  \"username\": \"string\",          // Username or email\n  \"password\": \"string\",          // User password\n  \"tenant_slug\": \"string\",       // Optional tenant context\n  \"remember_me\": false,           // Optional extended session\n  \"device_info\": {                // Optional device information\n    \"user_agent\": \"string\",\n    \"platform\": \"string\"\n  }\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Login successful.\",\n  \"data\": {\n    \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\",\n    \"refresh_token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\",\n    \"expires_in\": 900,\n    \"token_type\": \"Bearer\",\n    \"user\": {\n      \"id\": 123,\n      \"username\": \"john_doe\",\n      \"email\": \"john@example.com\",\n      \"first_name\": \"John\",\n      \"last_name\": \"Doe\"\n    },\n    \"tenant\": {\n      \"id\": 456,\n      \"name\": \"ACME Corp\",\n      \"slug\": \"acme-corp\",\n      \"is_active\": true\n    },\n    \"session_info\": {\n      \"session_id\": \"abc123...\",\n      \"created_at\": \"2024-01-01T12:00:00Z\",\n      \"device_info\": {...}\n    }\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n**Error Responses:**\n\n- `400 Bad Request`: Invalid login data\n- `401 Unauthorized`: Invalid credentials\n- `429 Too Many Requests`: Rate limit exceeded\n\n#### Token Refresh\n\n**POST** `/api/auth/refresh/`\n\nRefresh access token using refresh token.\n\n**Request Body:**\n```json\n{\n  \"refresh_token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\",\n  \"device_info\": {                // Optional updated device info\n    \"user_agent\": \"string\",\n    \"platform\": \"string\"\n  }\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Token refreshed successfully.\",\n  \"data\": {\n    \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\",\n    \"refresh_token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\",\n    \"expires_in\": 900,\n    \"token_type\": \"Bearer\"\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n#### User Registration\n\n**POST** `/api/auth/register/`\n\nRegister a new user account.\n\n**Request Body:**\n```json\n{\n  \"username\": \"string\",          // Unique username\n  \"email\": \"string\",             // Valid email address\n  \"password\": \"string\",          // Strong password\n  \"password_confirm\": \"string\",  // Password confirmation\n  \"first_name\": \"string\",        // Optional first name\n  \"last_name\": \"string\",         // Optional last name\n  \"tenant_slug\": \"string\"        // Optional tenant to join\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"user\": {\n      \"id\": 123,\n      \"username\": \"john_doe\",\n      \"email\": \"john@example.com\",\n      \"first_name\": \"John\",\n      \"last_name\": \"Doe\",\n      \"date_joined\": \"2024-01-01T12:00:00Z\"\n    },\n    \"message\": \"Registration successful. You can now log in.\"\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n#### Logout\n\n**POST** `/api/auth/logout/`\n\nLogout user and revoke tokens.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Request Body:**\n```json\n{\n  \"refresh_token\": \"string\",      // Optional refresh token to revoke\n  \"revoke_all_sessions\": false    // Optional revoke all user sessions\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Session revoked successfully.\",\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n### User Management Endpoints\n\n#### Get User Profile\n\n**GET** `/api/auth/profile/`\n\nGet current user profile information.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": 123,\n    \"username\": \"john_doe\",\n    \"email\": \"john@example.com\",\n    \"first_name\": \"John\",\n    \"last_name\": \"Doe\",\n    \"is_active\": true,\n    \"date_joined\": \"2024-01-01T12:00:00Z\",\n    \"last_login\": \"2024-01-01T12:00:00Z\",\n    \"current_tenant\": {\n      \"id\": 456,\n      \"name\": \"ACME Corp\",\n      \"slug\": \"acme-corp\",\n      \"role\": \"admin\"\n    },\n    \"tenant_memberships\": [\n      {\n        \"tenant_id\": 456,\n        \"tenant_name\": \"ACME Corp\",\n        \"tenant_slug\": \"acme-corp\",\n        \"role\": \"admin\",\n        \"joined_at\": \"2024-01-01T12:00:00Z\"\n      }\n    ]\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n#### Update User Profile\n\n**PATCH** `/api/auth/profile/`\n\nUpdate user profile information.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Request Body:**\n```json\n{\n  \"first_name\": \"string\",        // Optional first name\n  \"last_name\": \"string\"          // Optional last name\n}\n```\n\n#### Change Password\n\n**POST** `/api/auth/change-password/`\n\nChange user password.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Request Body:**\n```json\n{\n  \"current_password\": \"string\",      // Current password\n  \"new_password\": \"string\",          // New password\n  \"new_password_confirm\": \"string\"   // New password confirmation\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Password changed successfully. 2 other sessions were revoked.\",\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n### Session Management Endpoints\n\n#### Get Active Sessions\n\n**GET** `/api/auth/sessions/`\n\nGet user's active sessions.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"sessions\": [\n      {\n        \"session_id\": \"abc123...\",\n        \"is_current\": true,\n        \"created_at\": \"2024-01-01T12:00:00Z\",\n        \"last_activity\": \"2024-01-01T12:30:00Z\",\n        \"device_info\": {\n          \"user_agent\": \"Mozilla/5.0...\",\n          \"platform\": \"web\",\n          \"ip_address\": \"192.168.1.100\"\n        }\n      }\n    ],\n    \"total_count\": 1\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n#### Revoke Session\n\n**DELETE** `/api/auth/sessions/?session_id=<session_id>`\n\nRevoke a specific session.\n\n**Headers:**\n```\nAuthorization: Bearer <access_token>\n```\n\n**Query Parameters:**\n- `session_id` (required): Session ID to revoke\n\n### Utility Endpoints\n\n#### Health Check\n\n**GET** `/api/auth/health/`\n\nCheck authentication service health.\n\n**Response:**\n```json\n{\n  \"status\": \"healthy\",\n  \"service\": \"authentication\",\n  \"timestamp\": \"2024-01-01T12:00:00Z\",\n  \"version\": \"1.0.0\"\n}\n```\n\n#### Token Validation\n\n**POST** `/api/auth/validate-token/`\n\nValidate a token (for external services).\n\n**Request Body:**\n```json\n{\n  \"token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\"\n}\n```\n\n**Response:**\n```json\n{\n  \"valid\": true,\n  \"user_id\": 123,\n  \"tenant_id\": 456,\n  \"expires_at\": 1640996100,\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n## Authentication Flow\n\n### 1. Initial Authentication\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API\n    participant Auth\n    participant DB\n    \n    Client->>API: POST /api/auth/login/\n    API->>Auth: Validate credentials\n    Auth->>DB: Check user & tenant\n    DB-->>Auth: User & tenant data\n    Auth->>Auth: Generate JWT tokens\n    Auth-->>API: Tokens & session info\n    API-->>Client: Access & refresh tokens\n```\n\n### 2. Authenticated Requests\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant Middleware\n    participant Auth\n    participant API\n    \n    Client->>Middleware: Request with JWT\n    Middleware->>Auth: Validate token\n    Auth->>Auth: Check blacklist\n    Auth-->>Middleware: Token claims\n    Middleware->>Middleware: Set user context\n    Middleware->>API: Forward request\n    API-->>Client: Response\n```\n\n### 3. Token Refresh\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API\n    participant Auth\n    participant Cache\n    \n    Client->>API: POST /api/auth/refresh/\n    API->>Auth: Validate refresh token\n    Auth->>Cache: Check token validity\n    Cache-->>Auth: Token status\n    Auth->>Auth: Generate new tokens\n    Auth->>Cache: Store new tokens\n    Auth-->>API: New token pair\n    API-->>Client: New access & refresh tokens\n```\n\n## Multi-Tenant Authentication\n\n### Tenant Context\n\nWhen logging in with a tenant context:\n\n1. User provides `tenant_slug` in login request\n2. System validates user has access to the tenant\n3. JWT tokens include tenant information:\n   - `tenant_id`: Tenant identifier\n   - `tenant_slug`: Tenant slug\n   - `tenant_role`: User's role in the tenant\n   - `tenant_permissions`: User's permissions in the tenant\n\n### Tenant-Aware Requests\n\nAuthenticated requests automatically include tenant context:\n\n```python\n# Request object includes tenant information\nrequest.user          # Authenticated user\nrequest.tenant        # Current tenant (if any)\nrequest.tenant_role   # User's role in tenant\nrequest.tenant_permissions  # User's permissions in tenant\n```\n\n### Cross-Tenant Access\n\nUsers can belong to multiple tenants. To switch tenant context:\n\n1. Logout from current session\n2. Login again with different `tenant_slug`\n3. New tokens will include the new tenant context\n\n## Security Features\n\n### 1. Rate Limiting\n\n- **Authentication endpoints**: 10 requests/minute per IP\n- **Token refresh**: 5 attempts/hour per user\n- **Brute force protection**: IP + username based blocking\n\n### 2. Token Security\n\n- **Short-lived access tokens**: 15 minutes expiry\n- **Encrypted sensitive claims**: Email, permissions encrypted\n- **Token blacklisting**: Immediate revocation capability\n- **Secure random generation**: Cryptographically secure tokens\n\n### 3. Session Management\n\n- **Session tracking**: Device and IP information\n- **Multiple session support**: Users can have multiple active sessions\n- **Session revocation**: Individual or bulk session termination\n- **Activity monitoring**: Last activity timestamps\n\n### 4. Audit Logging\n\n- **Authentication events**: Login, logout, failures\n- **Token operations**: Refresh, revocation\n- **Security events**: Brute force attempts, suspicious activity\n- **Session management**: Creation, termination, switching\n\n## Error Handling\n\n### Standard Error Response Format\n\n```json\n{\n  \"error\": \"error_code\",\n  \"message\": \"Human readable error message\",\n  \"details\": {                    // Optional additional details\n    \"field_errors\": {\n      \"field_name\": [\"Error message\"]\n    }\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n### Common Error Codes\n\n#### Authentication Errors\n\n- `authentication_failed`: Invalid credentials or token\n- `token_expired`: Access token has expired\n- `invalid_refresh_token`: Refresh token is invalid or expired\n- `account_disabled`: User account is disabled\n- `tenant_access_denied`: User doesn't have access to tenant\n\n#### Authorization Errors\n\n- `permission_denied`: Insufficient permissions\n- `role_required`: Required role not present\n- `tenant_required`: Tenant context required\n\n#### Rate Limiting Errors\n\n- `rate_limit_exceeded`: Too many requests\n- `brute_force_protection`: Account temporarily locked\n\n#### Validation Errors\n\n- `validation_failed`: Request data validation failed\n- `missing_required_field`: Required field missing\n- `invalid_format`: Field format invalid\n\n### HTTP Status Codes\n\n- `200 OK`: Successful request\n- `201 Created`: Resource created successfully\n- `400 Bad Request`: Invalid request data\n- `401 Unauthorized`: Authentication failed\n- `403 Forbidden`: Permission denied\n- `404 Not Found`: Resource not found\n- `429 Too Many Requests`: Rate limit exceeded\n- `500 Internal Server Error`: Server error\n\n## Client Implementation Examples\n\n### JavaScript/Fetch API\n\n```javascript\nclass AuthClient {\n  constructor(baseURL) {\n    this.baseURL = baseURL;\n    this.accessToken = localStorage.getItem('access_token');\n    this.refreshToken = localStorage.getItem('refresh_token');\n  }\n\n  async login(credentials) {\n    const response = await fetch(`${this.baseURL}/api/auth/login/`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(credentials)\n    });\n\n    if (response.ok) {\n      const data = await response.json();\n      this.accessToken = data.data.access_token;\n      this.refreshToken = data.data.refresh_token;\n      \n      localStorage.setItem('access_token', this.accessToken);\n      localStorage.setItem('refresh_token', this.refreshToken);\n      \n      return data;\n    }\n    \n    throw new Error('Login failed');\n  }\n\n  async makeRequest(url, options = {}) {\n    const headers = {\n      'Authorization': `Bearer ${this.accessToken}`,\n      'Content-Type': 'application/json',\n      ...options.headers\n    };\n\n    let response = await fetch(url, {\n      ...options,\n      headers\n    });\n\n    // Handle token refresh\n    if (response.status === 401) {\n      await this.refreshAccessToken();\n      \n      // Retry request with new token\n      headers['Authorization'] = `Bearer ${this.accessToken}`;\n      response = await fetch(url, {\n        ...options,\n        headers\n      });\n    }\n\n    return response;\n  }\n\n  async refreshAccessToken() {\n    const response = await fetch(`${this.baseURL}/api/auth/refresh/`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        refresh_token: this.refreshToken\n      })\n    });\n\n    if (response.ok) {\n      const data = await response.json();\n      this.accessToken = data.data.access_token;\n      this.refreshToken = data.data.refresh_token;\n      \n      localStorage.setItem('access_token', this.accessToken);\n      localStorage.setItem('refresh_token', this.refreshToken);\n    } else {\n      // Refresh failed, redirect to login\n      this.logout();\n      window.location.href = '/login';\n    }\n  }\n\n  async logout() {\n    if (this.refreshToken) {\n      await fetch(`${this.baseURL}/api/auth/logout/`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${this.accessToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          refresh_token: this.refreshToken\n        })\n      });\n    }\n\n    this.accessToken = null;\n    this.refreshToken = null;\n    localStorage.removeItem('access_token');\n    localStorage.removeItem('refresh_token');\n  }\n}\n\n// Usage\nconst auth = new AuthClient('https://api.example.com');\n\n// Login\nauth.login({\n  username: 'john_doe',\n  password: 'password123',\n  tenant_slug: 'acme-corp'\n});\n\n// Make authenticated request\nauth.makeRequest('/api/protected-endpoint/')\n  .then(response => response.json())\n  .then(data => console.log(data));\n```\n\n### Python/Requests\n\n```python\nimport requests\nimport json\nfrom datetime import datetime, timedelta\n\nclass AuthClient:\n    def __init__(self, base_url):\n        self.base_url = base_url\n        self.access_token = None\n        self.refresh_token = None\n        self.token_expires_at = None\n    \n    def login(self, credentials):\n        response = requests.post(\n            f\"{self.base_url}/api/auth/login/\",\n            json=credentials\n        )\n        response.raise_for_status()\n        \n        data = response.json()\n        self.access_token = data['data']['access_token']\n        self.refresh_token = data['data']['refresh_token']\n        self.token_expires_at = datetime.utcnow() + timedelta(seconds=data['data']['expires_in'])\n        \n        return data\n    \n    def _get_headers(self):\n        return {\n            'Authorization': f'Bearer {self.access_token}',\n            'Content-Type': 'application/json'\n        }\n    \n    def _refresh_token_if_needed(self):\n        if not self.access_token or datetime.utcnow() >= self.token_expires_at:\n            self._refresh_access_token()\n    \n    def _refresh_access_token(self):\n        response = requests.post(\n            f\"{self.base_url}/api/auth/refresh/\",\n            json={'refresh_token': self.refresh_token}\n        )\n        response.raise_for_status()\n        \n        data = response.json()\n        self.access_token = data['data']['access_token']\n        self.refresh_token = data['data']['refresh_token']\n        self.token_expires_at = datetime.utcnow() + timedelta(seconds=data['data']['expires_in'])\n    \n    def make_request(self, method, endpoint, **kwargs):\n        self._refresh_token_if_needed()\n        \n        response = requests.request(\n            method,\n            f\"{self.base_url}{endpoint}\",\n            headers=self._get_headers(),\n            **kwargs\n        )\n        \n        if response.status_code == 401:\n            # Try refreshing token and retrying\n            self._refresh_access_token()\n            response = requests.request(\n                method,\n                f\"{self.base_url}{endpoint}\",\n                headers=self._get_headers(),\n                **kwargs\n            )\n        \n        return response\n    \n    def logout(self):\n        if self.refresh_token:\n            requests.post(\n                f\"{self.base_url}/api/auth/logout/\",\n                headers=self._get_headers(),\n                json={'refresh_token': self.refresh_token}\n            )\n        \n        self.access_token = None\n        self.refresh_token = None\n        self.token_expires_at = None\n\n# Usage\nauth = AuthClient('https://api.example.com')\n\n# Login\nauth.login({\n    'username': 'john_doe',\n    'password': 'password123',\n    'tenant_slug': 'acme-corp'\n})\n\n# Make authenticated request\nresponse = auth.make_request('GET', '/api/protected-endpoint/')\ndata = response.json()\n```\n\n## Best Practices\n\n### For API Clients\n\n1. **Store tokens securely**: Use secure storage mechanisms\n2. **Handle token refresh**: Implement automatic token refresh\n3. **Respect rate limits**: Implement backoff strategies\n4. **Handle errors gracefully**: Provide user-friendly error messages\n5. **Monitor token expiry**: Refresh tokens before they expire\n\n### For API Development\n\n1. **Use HTTPS only**: Never transmit tokens over HTTP\n2. **Validate all inputs**: Implement comprehensive validation\n3. **Log security events**: Monitor authentication patterns\n4. **Implement rate limiting**: Protect against abuse\n5. **Regular security audits**: Review and update security measures\n\n### For Multi-Tenant Applications\n\n1. **Validate tenant access**: Always verify user-tenant relationships\n2. **Isolate tenant data**: Ensure proper data isolation\n3. **Monitor cross-tenant access**: Log tenant switching events\n4. **Implement tenant-specific permissions**: Use granular permission systems\n5. **Regular access reviews**: Audit user-tenant memberships\n\nThis API authentication system provides a robust foundation for secure, scalable multi-tenant applications while maintaining ease of use for developers and end users."